---
title: "《PostgreSQL指南》记录"
date: 2024-12-22
aliases: ["/Daily Dev"]
tags: ["PostgreSQL"]
categories: ["Daily Dev"]
author: "Kurong"
showToc: true
TocOpen: true
draft: false
hidemeta: false
comments: false
description: ""
disableHLJS: false # to disable highlightjs
disableShare: true
disableHLJS: false
hideSummary: false
searchHidden: true
ShowBreadCrumbs: true
ShowPostNavLinks: true
ShowRssButtonInSectionTermList: true
UseHugoToc: true
---

# 《PostgreSQL指南》记录

## 数据库集簇、数据库和数据表

### 数据库集簇的逻辑结构

数据库集簇是一组数据库的集合，由一个 PostgreSQL 服务器管理。而数据库是数据对象的集合，数据库对象用于存储或引用数据的数据结构。

在 PosgreSQL 中，所有的数据库对象都通过相应的对象标识符（oid）进行管理，这些标识都是无符号 4 字节整型。

### 数据库集簇的物理结构

数据库集簇就是一个文件目录。对于 PostgreSQL，base 子目录中的每个子目录都是一个数据库，数据库中的每个表和索引都至少在相应子目录下存储为一个文件，且该子目录的名称与相应数据库的 oid 相同。

每个小于 1GB 的表或索引都在相应的数据库目录中存储为单个文件，这些文件通过 oid 进行管理。大小超过 1GB 时，会创建并使用一个名为 relfilenode.1 的新文件，如果也填满了就会创建 relfilenode.2 ，以此类推。文件的最大大小是可以通过配置文件更改的。

PostgreSQL 的表空间是基础目录之外的附加数据区域，表空间就像一个仓库，用来存放数据库文件。每个仓库可以放在不同的物理位置（比如不同的磁盘或路径）。默认情况下，PostgreSQL 有一个主仓库，叫 pg_default，所有的数据库和表默认都存放在这里。

### 堆表文件的内部布局

数据文件内部被划分成固定长度的区块，大小默认为 8KB，从 0 开始按顺序编号。如果文件已满，就在最后加一个新的区块。     

区块包含三种类型的数据：

- 堆元组：数据记录本身，从区块地步开始依序堆叠；
- 行指针：指向堆元组的指针；
- 首部数据：包含关于区块的元数据，大小为 24B。

为了识别表中的元组，数据库使用元组标识符（TID），它由区块号、指向元组的行指针的偏移号组成。

### 读写元组的方式

这里只讲述最基本的读写过程，其余细节留待后续章节描述。

写堆元组：

- PostgreSQL 在堆表的存储文件中找到有空闲空间的区块；
- 数据作为一条元组插入到这个区块的空闲空间中。

读堆元组：

- PostgreSQL 首先通过表的存储文件和区块号找到目标区块；
- 使用共享缓冲区，把目标区块加载到内存；
- PostgreSQL 遍历页面中的所有堆元组，检查每个元组是否满足查询条件。



## 进程和内存架构

### 进程架构

postgres 服务器进程是所有进程的父进程，它会在内存中分配共享内存区域，启动各种后台进程，并等待来自客户端的连接请求。每当接收到来自客户端的连接请求时，它都会启动一个后端进程，然后由启动的后端进程处理该客户端发出的所有查询。

每个后端进程由 postgres 服务器进程启动，并处理连接另一侧的客户端发出的查询。它通过单条 TCP 连接与客户端通信。PostgreSQL 没有原生的连接池功能，客户端与服务器频繁地建立断开连接会导致开销变大，可以通过池化中间件解决。

后台进程有很多种类，它们依赖于 PostgreSQL 的内部机制和特定的独立特性。

除了这三类进程外，还有复制相关进程、后台工作进程。

### 内存架构

PostgreSQL 的内存架构可以分为：

- 本地内存区域：由每个后端进程分配，自己使用。
- 共享内存区域：由所有进程使用。

​     

## 查询处理

### 概览

每个后端进程由以下 5 个子系统构成：

- 解析器：根据 SQL 语句生成一棵语法解析树；
- 分析器：对语法解析树进行语义分析，生成一棵查询树；
- 重写器：按照规则系统中的规则对查询树进行改写；
- 计划器：基于查询树生成一棵执行效率最高的计划树；
- 执行器：按照计划树中的顺序访问表和索引，执行相应查询。

解析器只会检查 SQL 语法，并不会检查语义是否正确。

### 单表查询的代价估计

### 创建单表查询的计划树

### 执行器的工作流程

### 连接

### 创建多表查询的计划树
