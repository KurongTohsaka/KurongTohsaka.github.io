<!doctype html><html lang=en dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>《gRPC与云原生应用开发》记录 | KurongBlog</title>
<meta name=keywords content="RPC,Cloud Native,Golang"><meta name=description content='《gRPC与云原生应用开发》记录
gRPC 入门
gRPC 的定义
gRPC 是一项进程间通信技术，可以用来连接、调用、操作和调试分布式异构应用程序。
开发 gRPC 应用程序时，要先定义服务接口：消费者消费信息的方式、消费者能够远程调用的方法以及调用方法所使用的参数和消息格式等。在服务定义中使用的语言叫作接口定义语言（IDL）。
下面是使用 protocol buffers 作为 IDL 来定义服务接口：


服务定义




 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20


// ProductInfo.proto
syntax = "proto3";
package ecommerce;  // 防止协议消息类型之间发生命名冲突

// 定义服务接口
service ProductInfo {
	rpc addProduct(Product) returns (ProductID);
	rpc getProduct(ProductID) returns (Product);
}

// 定义消息格式
message Product {
	string id = 1;
	string name = 2;
	string description = 3;
}

message ProductID {
	string value = 1;
}




上面定义完成之后，就使用 protocol buffers 编译器 protoc 生成服务器端和客户端代码。'><meta name=author content="Kurong"><link rel=canonical href=http://localhost:1313/posts/dailydev/grpc%E4%B8%8E%E4%BA%91%E5%8E%9F%E7%94%9F%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E8%AE%B0%E5%BD%95/><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as=style><link rel=icon href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=http://localhost:1313/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=http://localhost:1313/posts/dailydev/grpc%E4%B8%8E%E4%BA%91%E5%8E%9F%E7%94%9F%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E8%AE%B0%E5%BD%95/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})})</script><meta property="og:title" content="《gRPC与云原生应用开发》记录"><meta property="og:description" content='《gRPC与云原生应用开发》记录
gRPC 入门
gRPC 的定义
gRPC 是一项进程间通信技术，可以用来连接、调用、操作和调试分布式异构应用程序。
开发 gRPC 应用程序时，要先定义服务接口：消费者消费信息的方式、消费者能够远程调用的方法以及调用方法所使用的参数和消息格式等。在服务定义中使用的语言叫作接口定义语言（IDL）。
下面是使用 protocol buffers 作为 IDL 来定义服务接口：


服务定义




 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20


// ProductInfo.proto
syntax = "proto3";
package ecommerce;  // 防止协议消息类型之间发生命名冲突

// 定义服务接口
service ProductInfo {
	rpc addProduct(Product) returns (ProductID);
	rpc getProduct(ProductID) returns (Product);
}

// 定义消息格式
message Product {
	string id = 1;
	string name = 2;
	string description = 3;
}

message ProductID {
	string value = 1;
}




上面定义完成之后，就使用 protocol buffers 编译器 protoc 生成服务器端和客户端代码。'><meta property="og:type" content="article"><meta property="og:url" content="http://localhost:1313/posts/dailydev/grpc%E4%B8%8E%E4%BA%91%E5%8E%9F%E7%94%9F%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E8%AE%B0%E5%BD%95/"><meta property="og:image" content="http://localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-11-30T00:00:00+00:00"><meta property="article:modified_time" content="2024-11-30T00:00:00+00:00"><meta property="og:site_name" content="KurongBlog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="《gRPC与云原生应用开发》记录"><meta name=twitter:description content='《gRPC与云原生应用开发》记录
gRPC 入门
gRPC 的定义
gRPC 是一项进程间通信技术，可以用来连接、调用、操作和调试分布式异构应用程序。
开发 gRPC 应用程序时，要先定义服务接口：消费者消费信息的方式、消费者能够远程调用的方法以及调用方法所使用的参数和消息格式等。在服务定义中使用的语言叫作接口定义语言（IDL）。
下面是使用 protocol buffers 作为 IDL 来定义服务接口：


服务定义




 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20


// ProductInfo.proto
syntax = "proto3";
package ecommerce;  // 防止协议消息类型之间发生命名冲突

// 定义服务接口
service ProductInfo {
	rpc addProduct(Product) returns (ProductID);
	rpc getProduct(ProductID) returns (Product);
}

// 定义消息格式
message Product {
	string id = 1;
	string name = 2;
	string description = 3;
}

message ProductID {
	string value = 1;
}




上面定义完成之后，就使用 protocol buffers 编译器 protoc 生成服务器端和客户端代码。'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://localhost:1313/posts/"},{"@type":"ListItem","position":2,"name":"《gRPC与云原生应用开发》记录","item":"http://localhost:1313/posts/dailydev/grpc%E4%B8%8E%E4%BA%91%E5%8E%9F%E7%94%9F%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E8%AE%B0%E5%BD%95/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"《gRPC与云原生应用开发》记录","name":"《gRPC与云原生应用开发》记录","description":"《gRPC与云原生应用开发》记录 gRPC 入门 gRPC 的定义 gRPC 是一项进程间通信技术，可以用来连接、调用、操作和调试分布式异构应用程序。\n开发 gRPC 应用程序时，要先定义服务接口：消费者消费信息的方式、消费者能够远程调用的方法以及调用方法所使用的参数和消息格式等。在服务定义中使用的语言叫作接口定义语言（IDL）。\n下面是使用 protocol buffers 作为 IDL 来定义服务接口：\n服务定义\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // ProductInfo.proto syntax = \u0026#34;proto3\u0026#34;; package ecommerce; // 防止协议消息类型之间发生命名冲突 // 定义服务接口 service ProductInfo { rpc addProduct(Product) returns (ProductID); rpc getProduct(ProductID) returns (Product); } // 定义消息格式 message Product { string id = 1; string name = 2; string description = 3; } message ProductID { string value = 1; } 上面定义完成之后，就使用 protocol buffers 编译器 protoc 生成服务器端和客户端代码。\n","keywords":["RPC","Cloud Native","Golang"],"articleBody":"《gRPC与云原生应用开发》记录 gRPC 入门 gRPC 的定义 gRPC 是一项进程间通信技术，可以用来连接、调用、操作和调试分布式异构应用程序。\n开发 gRPC 应用程序时，要先定义服务接口：消费者消费信息的方式、消费者能够远程调用的方法以及调用方法所使用的参数和消息格式等。在服务定义中使用的语言叫作接口定义语言（IDL）。\n下面是使用 protocol buffers 作为 IDL 来定义服务接口：\n服务定义\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 // ProductInfo.proto syntax = \"proto3\"; package ecommerce; // 防止协议消息类型之间发生命名冲突 // 定义服务接口 service ProductInfo { rpc addProduct(Product) returns (ProductID); rpc getProduct(ProductID) returns (Product); } // 定义消息格式 message Product { string id = 1; string name = 2; string description = 3; } message ProductID { string value = 1; } 上面定义完成之后，就使用 protocol buffers 编译器 protoc 生成服务器端和客户端代码。\ngRPC 服务端\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 import ( \"context\" pb \".../proto\" \"google.golang.org/grpc\" ) // ProductInfo 的 go 实现 func (s *server) AddProduct(ctx context.Context, in *pb.Product) (*pb.ProductID, error) { // 业务逻辑 } func (s *server) getProduct(ctx context.Context, in *pb.ProductID) (*pb.Product, error) { // 业务逻辑 } gRPC 服务端要做两件事：\n通过重载服务基类，实现所生成的服务器端骨架的逻辑\n运行 gRPC 服务器，监听来自客户端的请求并返回服务响应\n1 2 3 4 5 6 7 8 func main() { lis, _ := net.listen(\"tcp\". port) s := grpc.NewServer() pb.RegisterProductInfoServer(s, \u0026server()) if err := s.Serve(lis); err != nil { log.Fatalf(\"failed to serve: %v\", err) } } gRPC 客户端\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // 使用远程服务器地址创建通道 ManagedChannel channel = ManagedChannelBuiler.forAddress(\"localhost\", 8080) .usePlaintext(true) .build() // 使用通道初始化阻塞式存根 ProductInfoGrpc.ProductInfoBlockingStub stub = ProductInfoGrpc.newBlockingStub(channel) // 使用阻塞式存根调用远程方法 StringValue ProductID = stub.addProduct( Product.newBuiler() .setName(\"Apple\") .setDescription(\"Apple\") .build() ) 可以使用服务定义生成客户端存根，它提供了与服务端类似的方法，供客户端进行调用。\n客户端-服务端的消息流：当调用 gRPC服务时，客户端的 gRPC 库会使用 protpcol buffers，并将 RPC 的请求编排（marshal）为 protocol buffers 格式，然后将其通过 HTTP/2 进行发送。在服务端，请求会被解排（unmarshal），对应的过程调用会使用 protocol buffers 来执行。\nRPC 演进 传统的 RPC：通用对象请求代理体系结构（CORBA）和 Java 远程方法调用（RMI）。基于 TCP 构建，很复杂，且限制较多； 简单对象访问协议（SOAP）：在服务之间基于 XML 交换数据，并能基于任意的底层通信协议进行通信，如HTTP。但是消息格式复杂、规范复杂； 描述性状态迁移（REST）：基于 HTTP 实现。REST 架构风格已经成为构建微服务的标准方法了，但是其仍然有局限性： 基于文本的低效消息协议：使用 json 等人类可读形式的文本类型在服务间通信时是低效的； 应用程序之间缺乏强类型接口：不同语言构建的服务通过网络进行交互，导致缺乏明确定义和强类型的服务接口成为了使用 RESTful 服务的主要阻碍； REST 架构风格难以强制实施：虽然有一些“好的实践”，而且只有遵循这些实践才能构建真正的 RESTful 服务。但是 REST 架构不是强制性的。且那些实践难以实施。 gRPC：2015年由Google开源。真神降临 😊 gRPC 的优势所在：\n高效的进程间通信：使用基于 HTTP/2 的 protocol buffers 进行进程间通信； 简单且定义良好的服务接口和模式：使用 IDL 定义服务接口，可以保证简单但一致、可靠且可扩展的开发体验； 属于强类型：明确了服务接口的输入、返回的消息类型，属于强类型； 支持多语言（语言中立）； 支持全双工：可以开发流服务或流客户端； 具备多种特性：支持认证、加密、弹性、负载均衡、服务发现等； 与云原生的集成：是 CNCF 的一部分，大多数现代框架和技术都提供了对 gRPC 的原生支持。 开始使用 gRPC 创建服务定义 正如一开始的“gRPC 入门”篇章中的代码片段，先定义消息类型、服务接口。完成服务定义后，就是生成代码并进行实现了。\nGo 实现 gRPC 服务端：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 package main import ( \"context\" \"errors\" \"log\" \"github.com/gofrs/uuid\" pb \"productinfo/service/ecommerce\" ) // 中间件交互的抽象 type server struct { productMap map[string]*pb.Product } func (s *server) AddProduct(ctx context.Context, in *pb.Product) (*pb.ProductID, error) { out, err := uuid.NewV4() if err != nil { return nil, status.Errorf(codes.Internal, \"Error while generating Product ID\", err) } in.Id = out.String() if s.productMap != nil { s.ProductMap = make(map[string]*pb.Product) } s.productMap[in.Id] = in return \u0026pb.ProductID{Value: in.Id}, status.New(codes.OK, \"\").Err() } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 package main import { \"log\" \"net\" pb \"productinfo/service/ecommerce\" \"google.golang.org/grpc\" } const ( port = \":50051\" ) func main() { lis, err := net.listen(\"tcp\". port) if err != nil { log.Fatalf(\"failed to listen: %v\", err) } // 创建服务器并监听 s := grpc.NewServer() pb.RegisterProductInfoServer(s, \u0026server()) log.Printf(\"Starting gRPC listener on port \"+ port) if err := s.Serve(lis); err != nil { log.Fatalf(\"failed to serve: %v\", err) } } gRPC 客户端：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 package main import ( \"context\" \"time\" \"log\" \"google.golang.org/grpc\" pb \"productinfo/service/ecommerce\" ) const ( address = \"localhost:50051\" ) func main() { conn, errr := grpc.Dial(address. grpc.WithInsecure()) if err != nil { log.Fatalf(\"did not connect: %v\", err) } defer conn.close() c := pb.NewProductInfoClient(conn) ctx, cancel := context.WithTimeout(context.Background(), time.Second) defer cancel() name := \"Apple 11\" description := \"Apple 11\" price := float32(1000.0) r, err := c.AddProduct(ctx, \u0026pb.Product{Name: name, Description: description, Price: price}) if err != nil { log.Fatalf(\"Could not add product: %v\", err) } log.Printf(\"Product ID: %s added successfully\", r.Value) product, err := c.GetProduct(ctx, \u0026pb.ProductID(Value: r.Value)) if err != nil { log.Fatalf(\"Could not get product: %v\", err) } log.Printf(\"Product: \", Product.String()) } gRPC 的通信模式 一元 RPC 模式 前面出现的示例就是一元 RPC 模式，一个服务端、一个客户端，通信时始终只有一个请求和一个响应。这种方式适用于大多数的进程间通信。\n服务端流 RPC 模式 在服务端流 RPC 模式，服务端接收到客户端的请求消息后，会发回一个响应的序列，这个序列叫做“流”。在将所有的服务端响应发送结束后，服务端会以 trailer 元数据的形式将其状态发送给客户端，从而标记流的结束。\n使用方式：\n服务定义：返回是 stream 类型\n1 2 3 service OrderManagement { rpc searchOrders(google.protobuf.StringValue) returns (stream Order); } 服务端实现：\n1 2 3 4 5 6 func (s *server) SearchOrders(searchQuery *wrappers.StringValue, stream pb.OrderManagement_SearchOrdersServer) error { // 业务逻辑 ... err := stream.Send(\u0026order) // 通过 send 发送到流中 return nil } 接收 stream 的响应，最后返回 nil 来标记流已经结束。\n客户端实现：\n1 2 3 4 5 6 7 8 9 10 11 ... c := pb.NewOrderManagementClient(conn) ... searchStream, _ := c.SearchOrders(ctx, \u0026wrapper.StringValue{Value: \"Google\"}) for { searchOrder, err := searchStream.Recv() if err == io.EOF { // 流已经结束 break } log.Printf(\"Search Result: \", searchOrder) } 客户端流 RPC 模式 在客户端流 RPC 模式，客户端会发送多个请求给服务端，服务端会发送一个响应给客户端。但是服务端不一定要等到客户端接收到所有消息后才发送响应。\n使用方式：\n服务定义：请求是 stream 类型\n1 2 3 service OrderManagement { rpc updateOrders(stream Order) returns (google.protobuf.StringValue); } 服务端实现：\n1 2 3 4 5 6 7 func (s *server) UpdateOrders(stream pb.OrderManagement_UpdateOrdersServer) error { ... order, err := stream.Recv() ... return stream.SendAndClose(...) // 服务端通过该方法发送响应 ... } 客户端实现：\n1 2 3 4 5 6 7 8 9 ... c := pb.NewOrderManagementClient(conn) ... if err := updateStream.Send(\u0026upOrder1); err != nil { // 客户端通过 Send 连续发送多条请求 log.Fatalf(...) } ... updateRes, err := updateStream.CloseAndRecv() // 接收响应 ... 双向流 RPC 模式 在双向流 RPC 模式中，客户端以消息流的形式发送请求到服务端，服务端也以消息流形式响应。\n流的操作完全独立，客户端和服务端可以按照任意顺序进行读取和写入。一旦建立连接，通信模式就完全取决于客户端和服务端本身。\ngRPC 的底层原理 RPC 流 一个基本的 gRPC 过程，以 getProduct 方法为例：\n客户端通过生成的存根调用 getProduct方法； 客户端存根使用已编码的消息创建 POST 请求。在 gRPC 中所有的请求都是 PSOT，并且 content-type 的值为 application/grpc ； HTTP 请求消息通过网络发送到服务端； 接收到消息后，服务端检查消息头消息，确定要调用的方法，然后将消息传递给服务端骨架； 服务端骨架将消息解析成特定的数据结构； 借助解析后的消息，服务发起对 getProduct 方法的本地调用。 gRPC 的这些步骤与其他 RPC 方式很相似，而主要区别在与消息的编码方式。gRPC 采用 protocol buffers。\n使用 protocol buffers 编码消息 对于 protocol buffers 中的消息定义：\n1 2 3 message ProductID { string value = 1; } 消息在经过编码后的字节流：消息字段1、消息字段2、….、结束标志。\n每个消息字段由标签、值两部分组成，标签由字段索引和线路类型（wire type）组成，字段索引就是上面消息定义里的“1”，线路类型则是该消息字段所属数据结构的类型，如 string 属于 “2:基于长度分隔”，那么其线路类型就是 2。值的编码会根据数据类型而不同。 基于长度前缀的消息分帧 长度前缀分帧是指在写入消息本身之前，写入长度信息，来表明每条消息的大小。\n在 gRPC 通信中，每条消息都有额外的4字节用来设置其大小，这表示 gRPC 通信可以处理大小不超过 4GB 的所有消息。\n除了消息的大小外，还有单字节的无符号整数，用于表明数据是否进行了压缩。\n基于 HTTP/2 的 gRPC 请求消息：请求消息包含请求头信息、以长度作为前缀的消息、流结束标记 EOS。远程调用会在客户端发送请求信息之后就会初始化，然后发送以长度作为前缀的消息，最后发送 EOS 标记。 响应消息：响应消息包含响应头消息、以长度作为前缀的消息、trailer，这个也是发送顺序。 那么，从这个角度再来重新看下 gRPC 的通信模式：\n一元 RPC 模式：就是以上面消息原始的方式互相发出去； 服务端流 RPC 模式：请求消息不变，响应消息中以长度作为前缀的消息可以是多个； 客户端流 RPC 模式：响应消息不变，请求消息中以长度作为前缀的消息可以是多个； 双向流 RPC 模式：两种消息的以长度作为前缀的消息都可以是多个。 至此，gRPC 在 HTTP/2 层的原理介绍就到这了。\ngRPC：超越基础知识 这一部分就不看了，就简单的把 gRPC 还能干啥写出来：\n拦截器 截止时间 取消 错误处理 多路复用 元数据 负载均衡 ","wordCount":"963","inLanguage":"en","image":"http://localhost:1313/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2024-11-30T00:00:00Z","dateModified":"2024-11-30T00:00:00Z","author":{"@type":"Person","name":"Kurong"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:1313/posts/dailydev/grpc%E4%B8%8E%E4%BA%91%E5%8E%9F%E7%94%9F%E5%BA%94%E7%94%A8%E5%BC%80%E5%8F%91%E8%AE%B0%E5%BD%95/"},"publisher":{"@type":"Organization","name":"KurongBlog","logo":{"@type":"ImageObject","url":"http://localhost:1313/%3Clink%20/%20abs%20url%3E"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/ accesskey=h title="Home (Alt + H)"><img src=http://localhost:1313/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://localhost:1313/categories/ title=categories><span>categories</span></a></li><li><a href=http://localhost:1313/tags/ title=tags><span>tags</span></a></li><li><a href=http://localhost:1313/search/ title="search (Alt + /)" accesskey=/><span>search</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://localhost:1313/>Home</a>&nbsp;»&nbsp;<a href=http://localhost:1313/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">《gRPC与云原生应用开发》记录</h1><div class=post-meta><span title='2024-11-30 00:00:00 +0000 UTC'>November 30, 2024</span>&nbsp;·&nbsp;Kurong&nbsp;|&nbsp;<a href=https://github.com/KurongTohsaka/KurongTohsaka.github.io/content/posts/DailyDev/%e3%80%8agRPC%e4%b8%8e%e4%ba%91%e5%8e%9f%e7%94%9f%e5%ba%94%e7%94%a8%e5%bc%80%e5%8f%91%e3%80%8b%e8%ae%b0%e5%bd%95.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#grpc-入门>gRPC 入门</a><ul><li><a href=#grpc-的定义>gRPC 的定义</a></li><li><a href=#rpc-演进>RPC 演进</a></li></ul></li><li><a href=#开始使用-grpc>开始使用 gRPC</a><ul><li><a href=#创建服务定义>创建服务定义</a></li><li><a href=#go-实现>Go 实现</a></li></ul></li><li><a href=#grpc-的通信模式>gRPC 的通信模式</a><ul><li><a href=#一元-rpc-模式>一元 RPC 模式</a></li><li><a href=#服务端流-rpc-模式>服务端流 RPC 模式</a></li><li><a href=#客户端流-rpc-模式>客户端流 RPC 模式</a></li><li><a href=#双向流-rpc-模式>双向流 RPC 模式</a></li></ul></li><li><a href=#grpc-的底层原理>gRPC 的底层原理</a><ul><li><a href=#rpc-流>RPC 流</a></li><li><a href=#使用-protocol-buffers-编码消息>使用 protocol buffers 编码消息</a></li><li><a href=#基于长度前缀的消息分帧>基于长度前缀的消息分帧</a></li><li><a href=#基于-http2-的-grpc>基于 HTTP/2 的 gRPC</a></li></ul></li><li><a href=#grpc超越基础知识>gRPC：超越基础知识</a></li></ul></nav></div></details></div><div class=post-content><h1 id=grpc与云原生应用开发记录>《gRPC与云原生应用开发》记录<a hidden class=anchor aria-hidden=true href=#grpc与云原生应用开发记录>#</a></h1><h2 id=grpc-入门>gRPC 入门<a hidden class=anchor aria-hidden=true href=#grpc-入门>#</a></h2><h3 id=grpc-的定义>gRPC 的定义<a hidden class=anchor aria-hidden=true href=#grpc-的定义>#</a></h3><p>gRPC 是一项进程间通信技术，可以用来连接、调用、操作和调试分布式异构应用程序。</p><p>开发 gRPC 应用程序时，要先定义服务接口：消费者消费信息的方式、消费者能够远程调用的方法以及调用方法所使用的参数和消息格式等。在服务定义中使用的语言叫作接口定义语言（IDL）。</p><p>下面是使用 protocol buffers 作为 IDL 来定义服务接口：</p><ul><li><p>服务定义</p><ul><li><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-0-1><a class=lnlinks href=#hl-0-1> 1</a>
</span><span class=lnt id=hl-0-2><a class=lnlinks href=#hl-0-2> 2</a>
</span><span class=lnt id=hl-0-3><a class=lnlinks href=#hl-0-3> 3</a>
</span><span class=lnt id=hl-0-4><a class=lnlinks href=#hl-0-4> 4</a>
</span><span class=lnt id=hl-0-5><a class=lnlinks href=#hl-0-5> 5</a>
</span><span class=lnt id=hl-0-6><a class=lnlinks href=#hl-0-6> 6</a>
</span><span class=lnt id=hl-0-7><a class=lnlinks href=#hl-0-7> 7</a>
</span><span class=lnt id=hl-0-8><a class=lnlinks href=#hl-0-8> 8</a>
</span><span class=lnt id=hl-0-9><a class=lnlinks href=#hl-0-9> 9</a>
</span><span class=lnt id=hl-0-10><a class=lnlinks href=#hl-0-10>10</a>
</span><span class=lnt id=hl-0-11><a class=lnlinks href=#hl-0-11>11</a>
</span><span class=lnt id=hl-0-12><a class=lnlinks href=#hl-0-12>12</a>
</span><span class=lnt id=hl-0-13><a class=lnlinks href=#hl-0-13>13</a>
</span><span class=lnt id=hl-0-14><a class=lnlinks href=#hl-0-14>14</a>
</span><span class=lnt id=hl-0-15><a class=lnlinks href=#hl-0-15>15</a>
</span><span class=lnt id=hl-0-16><a class=lnlinks href=#hl-0-16>16</a>
</span><span class=lnt id=hl-0-17><a class=lnlinks href=#hl-0-17>17</a>
</span><span class=lnt id=hl-0-18><a class=lnlinks href=#hl-0-18>18</a>
</span><span class=lnt id=hl-0-19><a class=lnlinks href=#hl-0-19>19</a>
</span><span class=lnt id=hl-0-20><a class=lnlinks href=#hl-0-20>20</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=c1>// ProductInfo.proto
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>syntax</span> <span class=o>=</span> <span class=s>&#34;proto3&#34;</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kn>package</span> <span class=nn>ecommerce</span><span class=p>;</span>  <span class=c1>// 防止协议消息类型之间发生命名冲突
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c1>// 定义服务接口
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>service</span> <span class=n>ProductInfo</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>	<span class=k>rpc</span> <span class=n>addProduct</span><span class=p>(</span><span class=n>Product</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>ProductID</span><span class=p>);</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>	<span class=k>rpc</span> <span class=n>getProduct</span><span class=p>(</span><span class=n>ProductID</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>Product</span><span class=p>);</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c1>// 定义消息格式
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>message</span> <span class=nc>Product</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>	<span class=kt>string</span> <span class=n>id</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>	<span class=kt>string</span> <span class=n>name</span> <span class=o>=</span> <span class=mi>2</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>	<span class=kt>string</span> <span class=n>description</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=kd>message</span> <span class=nc>ProductID</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>	<span class=kt>string</span> <span class=n>value</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>上面定义完成之后，就使用 protocol buffers 编译器 protoc 生成服务器端和客户端代码。</p></li></ul></li><li><p>gRPC 服务端</p><ul><li><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-1-1><a class=lnlinks href=#hl-1-1> 1</a>
</span><span class=lnt id=hl-1-2><a class=lnlinks href=#hl-1-2> 2</a>
</span><span class=lnt id=hl-1-3><a class=lnlinks href=#hl-1-3> 3</a>
</span><span class=lnt id=hl-1-4><a class=lnlinks href=#hl-1-4> 4</a>
</span><span class=lnt id=hl-1-5><a class=lnlinks href=#hl-1-5> 5</a>
</span><span class=lnt id=hl-1-6><a class=lnlinks href=#hl-1-6> 6</a>
</span><span class=lnt id=hl-1-7><a class=lnlinks href=#hl-1-7> 7</a>
</span><span class=lnt id=hl-1-8><a class=lnlinks href=#hl-1-8> 8</a>
</span><span class=lnt id=hl-1-9><a class=lnlinks href=#hl-1-9> 9</a>
</span><span class=lnt id=hl-1-10><a class=lnlinks href=#hl-1-10>10</a>
</span><span class=lnt id=hl-1-11><a class=lnlinks href=#hl-1-11>11</a>
</span><span class=lnt id=hl-1-12><a class=lnlinks href=#hl-1-12>12</a>
</span><span class=lnt id=hl-1-13><a class=lnlinks href=#hl-1-13>13</a>
</span><span class=lnt id=hl-1-14><a class=lnlinks href=#hl-1-14>14</a>
</span><span class=lnt id=hl-1-15><a class=lnlinks href=#hl-1-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>pb</span> <span class=s>&#34;.../proto&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;google.golang.org/grpc&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// ProductInfo 的 go 实现
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>server</span><span class=p>)</span> <span class=nf>AddProduct</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>in</span> <span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Product</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>ProductID</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 业务逻辑
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>server</span><span class=p>)</span> <span class=nf>getProduct</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>in</span> <span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>ProductID</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Product</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 业务逻辑
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>gRPC 服务端要做两件事：</p><ul><li><p>通过重载服务基类，实现所生成的服务器端骨架的逻辑</p></li><li><p>运行 gRPC 服务器，监听来自客户端的请求并返回服务响应</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-2-1><a class=lnlinks href=#hl-2-1>1</a>
</span><span class=lnt id=hl-2-2><a class=lnlinks href=#hl-2-2>2</a>
</span><span class=lnt id=hl-2-3><a class=lnlinks href=#hl-2-3>3</a>
</span><span class=lnt id=hl-2-4><a class=lnlinks href=#hl-2-4>4</a>
</span><span class=lnt id=hl-2-5><a class=lnlinks href=#hl-2-5>5</a>
</span><span class=lnt id=hl-2-6><a class=lnlinks href=#hl-2-6>6</a>
</span><span class=lnt id=hl-2-7><a class=lnlinks href=#hl-2-7>7</a>
</span><span class=lnt id=hl-2-8><a class=lnlinks href=#hl-2-8>8</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=k>func</span> <span class=n>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>lis</span><span class=p>,</span> <span class=n>_</span> <span class=p>:</span><span class=o>=</span> <span class=n>net</span><span class=o>.</span><span class=n>listen</span><span class=p>(</span><span class=s2>&#34;tcp&#34;</span><span class=o>.</span> <span class=n>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>s</span> <span class=p>:</span><span class=o>=</span> <span class=n>grpc</span><span class=o>.</span><span class=n>NewServer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=n>pb</span><span class=o>.</span><span class=n>RegisterProductInfoServer</span><span class=p>(</span><span class=n>s</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>server</span><span class=p>())</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=n>err</span> <span class=p>:</span><span class=o>=</span> <span class=n>s</span><span class=o>.</span><span class=n>Serve</span><span class=p>(</span><span class=n>lis</span><span class=p>);</span> <span class=n>err</span> <span class=o>!=</span> <span class=n>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nb>log</span><span class=o>.</span><span class=n>Fatalf</span><span class=p>(</span><span class=s2>&#34;failed to serve: %v&#34;</span><span class=p>,</span> <span class=n>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></li></ul></li></ul></li><li><p>gRPC 客户端</p><ul><li><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-3-1><a class=lnlinks href=#hl-3-1> 1</a>
</span><span class=lnt id=hl-3-2><a class=lnlinks href=#hl-3-2> 2</a>
</span><span class=lnt id=hl-3-3><a class=lnlinks href=#hl-3-3> 3</a>
</span><span class=lnt id=hl-3-4><a class=lnlinks href=#hl-3-4> 4</a>
</span><span class=lnt id=hl-3-5><a class=lnlinks href=#hl-3-5> 5</a>
</span><span class=lnt id=hl-3-6><a class=lnlinks href=#hl-3-6> 6</a>
</span><span class=lnt id=hl-3-7><a class=lnlinks href=#hl-3-7> 7</a>
</span><span class=lnt id=hl-3-8><a class=lnlinks href=#hl-3-8> 8</a>
</span><span class=lnt id=hl-3-9><a class=lnlinks href=#hl-3-9> 9</a>
</span><span class=lnt id=hl-3-10><a class=lnlinks href=#hl-3-10>10</a>
</span><span class=lnt id=hl-3-11><a class=lnlinks href=#hl-3-11>11</a>
</span><span class=lnt id=hl-3-12><a class=lnlinks href=#hl-3-12>12</a>
</span><span class=lnt id=hl-3-13><a class=lnlinks href=#hl-3-13>13</a>
</span><span class=lnt id=hl-3-14><a class=lnlinks href=#hl-3-14>14</a>
</span><span class=lnt id=hl-3-15><a class=lnlinks href=#hl-3-15>15</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=c1>// 使用远程服务器地址创建通道
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>ManagedChannel</span> <span class=nx>channel</span> <span class=p>=</span> <span class=nx>ManagedChannelBuiler</span><span class=p>.</span><span class=nf>forAddress</span><span class=p>(</span><span class=s>&#34;localhost&#34;</span><span class=p>,</span> <span class=mi>8080</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=nf>usePlaintext</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>.</span><span class=nf>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 使用通道初始化阻塞式存根
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>ProductInfoGrpc</span><span class=p>.</span><span class=nx>ProductInfoBlockingStub</span> <span class=nx>stub</span> <span class=p>=</span> <span class=nx>ProductInfoGrpc</span><span class=p>.</span><span class=nf>newBlockingStub</span><span class=p>(</span><span class=nx>channel</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 使用阻塞式存根调用远程方法
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>StringValue</span> <span class=nx>ProductID</span> <span class=p>=</span> <span class=nx>stub</span><span class=p>.</span><span class=nf>addProduct</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>Product</span><span class=p>.</span><span class=nf>newBuiler</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nf>setName</span><span class=p>(</span><span class=s>&#34;Apple&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nf>setDescription</span><span class=p>(</span><span class=s>&#34;Apple&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>.</span><span class=nf>build</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>可以使用服务定义生成客户端存根，它提供了与服务端类似的方法，供客户端进行调用。</p></li></ul></li><li><p>客户端-服务端的消息流：当调用 gRPC服务时，客户端的 gRPC 库会使用 protpcol buffers，并将 RPC 的请求编排（marshal）为 protocol buffers 格式，然后将其通过 HTTP/2 进行发送。在服务端，请求会被解排（unmarshal），对应的过程调用会使用 protocol buffers 来执行。</p></li></ul><h3 id=rpc-演进>RPC 演进<a hidden class=anchor aria-hidden=true href=#rpc-演进>#</a></h3><ul><li>传统的 RPC：通用对象请求代理体系结构（CORBA）和 Java 远程方法调用（RMI）。基于 TCP 构建，很复杂，且限制较多；</li><li>简单对象访问协议（SOAP）：在服务之间基于 XML 交换数据，并能基于任意的底层通信协议进行通信，如HTTP。但是消息格式复杂、规范复杂；</li><li>描述性状态迁移（REST）：基于 HTTP 实现。REST 架构风格已经成为构建微服务的标准方法了，但是其仍然有局限性：<ul><li>基于文本的低效消息协议：使用 json 等人类可读形式的文本类型在服务间通信时是低效的；</li><li>应用程序之间缺乏强类型接口：不同语言构建的服务通过网络进行交互，导致缺乏明确定义和强类型的服务接口成为了使用 RESTful 服务的主要阻碍；</li><li>REST 架构风格难以强制实施：虽然有一些“好的实践”，而且只有遵循这些实践才能构建真正的 RESTful 服务。但是 REST 架构不是强制性的。且那些实践难以实施。</li></ul></li><li>gRPC：2015年由Google开源。真神降临 😊</li></ul><p>gRPC 的优势所在：</p><ul><li>高效的进程间通信：使用基于 HTTP/2 的 protocol buffers 进行进程间通信；</li><li>简单且定义良好的服务接口和模式：使用 IDL 定义服务接口，可以保证简单但一致、可靠且可扩展的开发体验；</li><li>属于强类型：明确了服务接口的输入、返回的消息类型，属于强类型；</li><li>支持多语言（语言中立）；</li><li>支持全双工：可以开发流服务或流客户端；</li><li>具备多种特性：支持认证、加密、弹性、负载均衡、服务发现等；</li><li>与云原生的集成：是 CNCF 的一部分，大多数现代框架和技术都提供了对 gRPC 的原生支持。</li></ul><h2 id=开始使用-grpc>开始使用 gRPC<a hidden class=anchor aria-hidden=true href=#开始使用-grpc>#</a></h2><h3 id=创建服务定义>创建服务定义<a hidden class=anchor aria-hidden=true href=#创建服务定义>#</a></h3><p>正如一开始的“gRPC 入门”篇章中的代码片段，先定义消息类型、服务接口。完成服务定义后，就是生成代码并进行实现了。</p><h3 id=go-实现>Go 实现<a hidden class=anchor aria-hidden=true href=#go-实现>#</a></h3><ul><li><p>gRPC 服务端：</p><ul><li><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-4-1><a class=lnlinks href=#hl-4-1> 1</a>
</span><span class=lnt id=hl-4-2><a class=lnlinks href=#hl-4-2> 2</a>
</span><span class=lnt id=hl-4-3><a class=lnlinks href=#hl-4-3> 3</a>
</span><span class=lnt id=hl-4-4><a class=lnlinks href=#hl-4-4> 4</a>
</span><span class=lnt id=hl-4-5><a class=lnlinks href=#hl-4-5> 5</a>
</span><span class=lnt id=hl-4-6><a class=lnlinks href=#hl-4-6> 6</a>
</span><span class=lnt id=hl-4-7><a class=lnlinks href=#hl-4-7> 7</a>
</span><span class=lnt id=hl-4-8><a class=lnlinks href=#hl-4-8> 8</a>
</span><span class=lnt id=hl-4-9><a class=lnlinks href=#hl-4-9> 9</a>
</span><span class=lnt id=hl-4-10><a class=lnlinks href=#hl-4-10>10</a>
</span><span class=lnt id=hl-4-11><a class=lnlinks href=#hl-4-11>11</a>
</span><span class=lnt id=hl-4-12><a class=lnlinks href=#hl-4-12>12</a>
</span><span class=lnt id=hl-4-13><a class=lnlinks href=#hl-4-13>13</a>
</span><span class=lnt id=hl-4-14><a class=lnlinks href=#hl-4-14>14</a>
</span><span class=lnt id=hl-4-15><a class=lnlinks href=#hl-4-15>15</a>
</span><span class=lnt id=hl-4-16><a class=lnlinks href=#hl-4-16>16</a>
</span><span class=lnt id=hl-4-17><a class=lnlinks href=#hl-4-17>17</a>
</span><span class=lnt id=hl-4-18><a class=lnlinks href=#hl-4-18>18</a>
</span><span class=lnt id=hl-4-19><a class=lnlinks href=#hl-4-19>19</a>
</span><span class=lnt id=hl-4-20><a class=lnlinks href=#hl-4-20>20</a>
</span><span class=lnt id=hl-4-21><a class=lnlinks href=#hl-4-21>21</a>
</span><span class=lnt id=hl-4-22><a class=lnlinks href=#hl-4-22>22</a>
</span><span class=lnt id=hl-4-23><a class=lnlinks href=#hl-4-23>23</a>
</span><span class=lnt id=hl-4-24><a class=lnlinks href=#hl-4-24>24</a>
</span><span class=lnt id=hl-4-25><a class=lnlinks href=#hl-4-25>25</a>
</span><span class=lnt id=hl-4-26><a class=lnlinks href=#hl-4-26>26</a>
</span><span class=lnt id=hl-4-27><a class=lnlinks href=#hl-4-27>27</a>
</span><span class=lnt id=hl-4-28><a class=lnlinks href=#hl-4-28>28</a>
</span><span class=lnt id=hl-4-29><a class=lnlinks href=#hl-4-29>29</a>
</span><span class=lnt id=hl-4-30><a class=lnlinks href=#hl-4-30>30</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;errors&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=s>&#34;github.com/gofrs/uuid&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>pb</span> <span class=s>&#34;productinfo/service/ecommerce&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 中间件交互的抽象
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kd>type</span> <span class=nx>server</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>productMap</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Product</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>server</span><span class=p>)</span> <span class=nf>AddProduct</span><span class=p>(</span><span class=nx>ctx</span> <span class=nx>context</span><span class=p>.</span><span class=nx>Context</span><span class=p>,</span> <span class=nx>in</span> <span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Product</span><span class=p>)</span> <span class=p>(</span><span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>ProductID</span><span class=p>,</span> <span class=kt>error</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>out</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>uuid</span><span class=p>.</span><span class=nf>NewV4</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=kc>nil</span><span class=p>,</span> <span class=nx>status</span><span class=p>.</span><span class=nf>Errorf</span><span class=p>(</span><span class=nx>codes</span><span class=p>.</span><span class=nx>Internal</span><span class=p>,</span> <span class=s>&#34;Error while generating Product ID&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>in</span><span class=p>.</span><span class=nx>Id</span> <span class=p>=</span> <span class=nx>out</span><span class=p>.</span><span class=nf>String</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>s</span><span class=p>.</span><span class=nx>productMap</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>s</span><span class=p>.</span><span class=nx>ProductMap</span> <span class=p>=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Product</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>s</span><span class=p>.</span><span class=nx>productMap</span><span class=p>[</span><span class=nx>in</span><span class=p>.</span><span class=nx>Id</span><span class=p>]</span> <span class=p>=</span> <span class=nx>in</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>ProductID</span><span class=p>{</span><span class=nx>Value</span><span class=p>:</span> <span class=nx>in</span><span class=p>.</span><span class=nx>Id</span><span class=p>},</span> <span class=nx>status</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>codes</span><span class=p>.</span><span class=nx>OK</span><span class=p>,</span> <span class=s>&#34;&#34;</span><span class=p>).</span><span class=nf>Err</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></li><li><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-5-1><a class=lnlinks href=#hl-5-1> 1</a>
</span><span class=lnt id=hl-5-2><a class=lnlinks href=#hl-5-2> 2</a>
</span><span class=lnt id=hl-5-3><a class=lnlinks href=#hl-5-3> 3</a>
</span><span class=lnt id=hl-5-4><a class=lnlinks href=#hl-5-4> 4</a>
</span><span class=lnt id=hl-5-5><a class=lnlinks href=#hl-5-5> 5</a>
</span><span class=lnt id=hl-5-6><a class=lnlinks href=#hl-5-6> 6</a>
</span><span class=lnt id=hl-5-7><a class=lnlinks href=#hl-5-7> 7</a>
</span><span class=lnt id=hl-5-8><a class=lnlinks href=#hl-5-8> 8</a>
</span><span class=lnt id=hl-5-9><a class=lnlinks href=#hl-5-9> 9</a>
</span><span class=lnt id=hl-5-10><a class=lnlinks href=#hl-5-10>10</a>
</span><span class=lnt id=hl-5-11><a class=lnlinks href=#hl-5-11>11</a>
</span><span class=lnt id=hl-5-12><a class=lnlinks href=#hl-5-12>12</a>
</span><span class=lnt id=hl-5-13><a class=lnlinks href=#hl-5-13>13</a>
</span><span class=lnt id=hl-5-14><a class=lnlinks href=#hl-5-14>14</a>
</span><span class=lnt id=hl-5-15><a class=lnlinks href=#hl-5-15>15</a>
</span><span class=lnt id=hl-5-16><a class=lnlinks href=#hl-5-16>16</a>
</span><span class=lnt id=hl-5-17><a class=lnlinks href=#hl-5-17>17</a>
</span><span class=lnt id=hl-5-18><a class=lnlinks href=#hl-5-18>18</a>
</span><span class=lnt id=hl-5-19><a class=lnlinks href=#hl-5-19>19</a>
</span><span class=lnt id=hl-5-20><a class=lnlinks href=#hl-5-20>20</a>
</span><span class=lnt id=hl-5-21><a class=lnlinks href=#hl-5-21>21</a>
</span><span class=lnt id=hl-5-22><a class=lnlinks href=#hl-5-22>22</a>
</span><span class=lnt id=hl-5-23><a class=lnlinks href=#hl-5-23>23</a>
</span><span class=lnt id=hl-5-24><a class=lnlinks href=#hl-5-24>24</a>
</span><span class=lnt id=hl-5-25><a class=lnlinks href=#hl-5-25>25</a>
</span><span class=lnt id=hl-5-26><a class=lnlinks href=#hl-5-26>26</a>
</span><span class=lnt id=hl-5-27><a class=lnlinks href=#hl-5-27>27</a>
</span><span class=lnt id=hl-5-28><a class=lnlinks href=#hl-5-28>28</a>
</span><span class=lnt id=hl-5-29><a class=lnlinks href=#hl-5-29>29</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;net&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>pb</span> <span class=s>&#34;productinfo/service/ecommerce&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;google.golang.org/grpc&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>port</span> <span class=p>=</span> <span class=s>&#34;:50051&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>lis</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>net</span><span class=p>.</span><span class=nf>listen</span><span class=p>(</span><span class=s>&#34;tcp&#34;</span><span class=p>.</span> <span class=nx>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;failed to listen: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// 创建服务器并监听
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>s</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>NewServer</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=nx>pb</span><span class=p>.</span><span class=nf>RegisterProductInfoServer</span><span class=p>(</span><span class=nx>s</span><span class=p>,</span> <span class=o>&amp;</span><span class=nf>server</span><span class=p>())</span>
</span></span><span class=line><span class=cl>  <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Starting gRPC listener on port &#34;</span><span class=o>+</span> <span class=nx>port</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>Serve</span><span class=p>(</span><span class=nx>lis</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;failed to serve: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></li></ul></li><li><p>gRPC 客户端：</p><ul><li><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-6-1><a class=lnlinks href=#hl-6-1> 1</a>
</span><span class=lnt id=hl-6-2><a class=lnlinks href=#hl-6-2> 2</a>
</span><span class=lnt id=hl-6-3><a class=lnlinks href=#hl-6-3> 3</a>
</span><span class=lnt id=hl-6-4><a class=lnlinks href=#hl-6-4> 4</a>
</span><span class=lnt id=hl-6-5><a class=lnlinks href=#hl-6-5> 5</a>
</span><span class=lnt id=hl-6-6><a class=lnlinks href=#hl-6-6> 6</a>
</span><span class=lnt id=hl-6-7><a class=lnlinks href=#hl-6-7> 7</a>
</span><span class=lnt id=hl-6-8><a class=lnlinks href=#hl-6-8> 8</a>
</span><span class=lnt id=hl-6-9><a class=lnlinks href=#hl-6-9> 9</a>
</span><span class=lnt id=hl-6-10><a class=lnlinks href=#hl-6-10>10</a>
</span><span class=lnt id=hl-6-11><a class=lnlinks href=#hl-6-11>11</a>
</span><span class=lnt id=hl-6-12><a class=lnlinks href=#hl-6-12>12</a>
</span><span class=lnt id=hl-6-13><a class=lnlinks href=#hl-6-13>13</a>
</span><span class=lnt id=hl-6-14><a class=lnlinks href=#hl-6-14>14</a>
</span><span class=lnt id=hl-6-15><a class=lnlinks href=#hl-6-15>15</a>
</span><span class=lnt id=hl-6-16><a class=lnlinks href=#hl-6-16>16</a>
</span><span class=lnt id=hl-6-17><a class=lnlinks href=#hl-6-17>17</a>
</span><span class=lnt id=hl-6-18><a class=lnlinks href=#hl-6-18>18</a>
</span><span class=lnt id=hl-6-19><a class=lnlinks href=#hl-6-19>19</a>
</span><span class=lnt id=hl-6-20><a class=lnlinks href=#hl-6-20>20</a>
</span><span class=lnt id=hl-6-21><a class=lnlinks href=#hl-6-21>21</a>
</span><span class=lnt id=hl-6-22><a class=lnlinks href=#hl-6-22>22</a>
</span><span class=lnt id=hl-6-23><a class=lnlinks href=#hl-6-23>23</a>
</span><span class=lnt id=hl-6-24><a class=lnlinks href=#hl-6-24>24</a>
</span><span class=lnt id=hl-6-25><a class=lnlinks href=#hl-6-25>25</a>
</span><span class=lnt id=hl-6-26><a class=lnlinks href=#hl-6-26>26</a>
</span><span class=lnt id=hl-6-27><a class=lnlinks href=#hl-6-27>27</a>
</span><span class=lnt id=hl-6-28><a class=lnlinks href=#hl-6-28>28</a>
</span><span class=lnt id=hl-6-29><a class=lnlinks href=#hl-6-29>29</a>
</span><span class=lnt id=hl-6-30><a class=lnlinks href=#hl-6-30>30</a>
</span><span class=lnt id=hl-6-31><a class=lnlinks href=#hl-6-31>31</a>
</span><span class=lnt id=hl-6-32><a class=lnlinks href=#hl-6-32>32</a>
</span><span class=lnt id=hl-6-33><a class=lnlinks href=#hl-6-33>33</a>
</span><span class=lnt id=hl-6-34><a class=lnlinks href=#hl-6-34>34</a>
</span><span class=lnt id=hl-6-35><a class=lnlinks href=#hl-6-35>35</a>
</span><span class=lnt id=hl-6-36><a class=lnlinks href=#hl-6-36>36</a>
</span><span class=lnt id=hl-6-37><a class=lnlinks href=#hl-6-37>37</a>
</span><span class=lnt id=hl-6-38><a class=lnlinks href=#hl-6-38>38</a>
</span><span class=lnt id=hl-6-39><a class=lnlinks href=#hl-6-39>39</a>
</span><span class=lnt id=hl-6-40><a class=lnlinks href=#hl-6-40>40</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;context&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl>  <span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=s>&#34;google.golang.org/grpc&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>pb</span> <span class=s>&#34;productinfo/service/ecommerce&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>const</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=nx>address</span> <span class=p>=</span> <span class=s>&#34;localhost:50051&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>conn</span><span class=p>,</span> <span class=nx>errr</span> <span class=o>:=</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>Dial</span><span class=p>(</span><span class=nx>address</span><span class=p>.</span> <span class=nx>grpc</span><span class=p>.</span><span class=nf>WithInsecure</span><span class=p>())</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;did not connect: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=k>defer</span> <span class=nx>conn</span><span class=p>.</span><span class=nb>close</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>c</span> <span class=o>:=</span> <span class=nx>pb</span><span class=p>.</span><span class=nf>NewProductInfoClient</span><span class=p>(</span><span class=nx>conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>ctx</span><span class=p>,</span> <span class=nx>cancel</span> <span class=o>:=</span> <span class=nx>context</span><span class=p>.</span><span class=nf>WithTimeout</span><span class=p>(</span><span class=nx>context</span><span class=p>.</span><span class=nf>Background</span><span class=p>(),</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Second</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=k>defer</span> <span class=nf>cancel</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>name</span> <span class=o>:=</span> <span class=s>&#34;Apple 11&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>description</span> <span class=o>:=</span> <span class=s>&#34;Apple 11&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nx>price</span> <span class=o>:=</span> <span class=nb>float32</span><span class=p>(</span><span class=mf>1000.0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=nx>r</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>AddProduct</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nx>Product</span><span class=p>{</span><span class=nx>Name</span><span class=p>:</span> <span class=nx>name</span><span class=p>,</span> <span class=nx>Description</span><span class=p>:</span> <span class=nx>description</span><span class=p>,</span> <span class=nx>Price</span><span class=p>:</span> <span class=nx>price</span><span class=p>})</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Could not add product: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Product ID: %s added successfully&#34;</span><span class=p>,</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Value</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=nx>product</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>GetProduct</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>pb</span><span class=p>.</span><span class=nf>ProductID</span><span class=p>(</span><span class=nx>Value</span><span class=p>:</span> <span class=nx>r</span><span class=p>.</span><span class=nx>Value</span><span class=p>))</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Could not get product: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Product: &#34;</span><span class=p>,</span> <span class=nx>Product</span><span class=p>.</span><span class=nf>String</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></li></ul></li></ul><h2 id=grpc-的通信模式>gRPC 的通信模式<a hidden class=anchor aria-hidden=true href=#grpc-的通信模式>#</a></h2><h3 id=一元-rpc-模式>一元 RPC 模式<a hidden class=anchor aria-hidden=true href=#一元-rpc-模式>#</a></h3><p>前面出现的示例就是一元 RPC 模式，一个服务端、一个客户端，通信时始终只有一个请求和一个响应。这种方式适用于大多数的进程间通信。</p><h3 id=服务端流-rpc-模式>服务端流 RPC 模式<a hidden class=anchor aria-hidden=true href=#服务端流-rpc-模式>#</a></h3><p>在服务端流 RPC 模式，服务端接收到客户端的请求消息后，会发回一个响应的序列，这个序列叫做“流”。在将所有的服务端响应发送结束后，服务端会以 trailer 元数据的形式将其状态发送给客户端，从而标记流的结束。</p><p>使用方式：</p><ul><li><p>服务定义：返回是 stream 类型</p><ul><li><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-7-1><a class=lnlinks href=#hl-7-1>1</a>
</span><span class=lnt id=hl-7-2><a class=lnlinks href=#hl-7-2>2</a>
</span><span class=lnt id=hl-7-3><a class=lnlinks href=#hl-7-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=kd>service</span> <span class=n>OrderManagement</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>	<span class=k>rpc</span> <span class=n>searchOrders</span><span class=p>(</span><span class=n>google.protobuf.StringValue</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>stream</span> <span class=n>Order</span><span class=p>);</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div></li></ul></li><li><p>服务端实现：</p><ul><li><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-8-1><a class=lnlinks href=#hl-8-1>1</a>
</span><span class=lnt id=hl-8-2><a class=lnlinks href=#hl-8-2>2</a>
</span><span class=lnt id=hl-8-3><a class=lnlinks href=#hl-8-3>3</a>
</span><span class=lnt id=hl-8-4><a class=lnlinks href=#hl-8-4>4</a>
</span><span class=lnt id=hl-8-5><a class=lnlinks href=#hl-8-5>5</a>
</span><span class=lnt id=hl-8-6><a class=lnlinks href=#hl-8-6>6</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>server</span><span class=p>)</span> <span class=nf>SearchOrders</span><span class=p>(</span><span class=nx>searchQuery</span> <span class=o>*</span><span class=nx>wrappers</span><span class=p>.</span><span class=nx>StringValue</span><span class=p>,</span> <span class=nx>stream</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>OrderManagement_SearchOrdersServer</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=c1>// 业务逻辑
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=nx>err</span> <span class=o>:=</span> <span class=nx>stream</span><span class=p>.</span><span class=nf>Send</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>order</span><span class=p>)</span>  <span class=c1>// 通过 send 发送到流中
</span></span></span><span class=line><span class=cl><span class=c1></span> 	<span class=k>return</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></li><li><p>接收 stream 的响应，最后返回 nil 来标记流已经结束。</p></li></ul></li><li><p>客户端实现：</p><ul><li><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-9-1><a class=lnlinks href=#hl-9-1> 1</a>
</span><span class=lnt id=hl-9-2><a class=lnlinks href=#hl-9-2> 2</a>
</span><span class=lnt id=hl-9-3><a class=lnlinks href=#hl-9-3> 3</a>
</span><span class=lnt id=hl-9-4><a class=lnlinks href=#hl-9-4> 4</a>
</span><span class=lnt id=hl-9-5><a class=lnlinks href=#hl-9-5> 5</a>
</span><span class=lnt id=hl-9-6><a class=lnlinks href=#hl-9-6> 6</a>
</span><span class=lnt id=hl-9-7><a class=lnlinks href=#hl-9-7> 7</a>
</span><span class=lnt id=hl-9-8><a class=lnlinks href=#hl-9-8> 8</a>
</span><span class=lnt id=hl-9-9><a class=lnlinks href=#hl-9-9> 9</a>
</span><span class=lnt id=hl-9-10><a class=lnlinks href=#hl-9-10>10</a>
</span><span class=lnt id=hl-9-11><a class=lnlinks href=#hl-9-11>11</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=nx>c</span> <span class=o>:=</span> <span class=nx>pb</span><span class=p>.</span><span class=nf>NewOrderManagementClient</span><span class=p>(</span><span class=nx>conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=nx>searchStream</span><span class=p>,</span> <span class=nx>_</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>SearchOrders</span><span class=p>(</span><span class=nx>ctx</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>wrapper</span><span class=p>.</span><span class=nx>StringValue</span><span class=p>{</span><span class=nx>Value</span><span class=p>:</span> <span class=s>&#34;Google&#34;</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>searchOrder</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>searchStream</span><span class=p>.</span><span class=nf>Recv</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=nx>err</span> <span class=o>==</span> <span class=nx>io</span><span class=p>.</span><span class=nx>EOF</span> <span class=p>{</span>  <span class=c1>// 流已经结束
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=k>break</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>log</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Search Result: &#34;</span><span class=p>,</span> <span class=nx>searchOrder</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></li></ul></li></ul><h3 id=客户端流-rpc-模式>客户端流 RPC 模式<a hidden class=anchor aria-hidden=true href=#客户端流-rpc-模式>#</a></h3><p>在客户端流 RPC 模式，客户端会发送多个请求给服务端，服务端会发送一个响应给客户端。但是服务端不一定要等到客户端接收到所有消息后才发送响应。</p><p>使用方式：</p><ul><li><p>服务定义：请求是 stream 类型</p><ul><li><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-10-1><a class=lnlinks href=#hl-10-1>1</a>
</span><span class=lnt id=hl-10-2><a class=lnlinks href=#hl-10-2>2</a>
</span><span class=lnt id=hl-10-3><a class=lnlinks href=#hl-10-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=kd>service</span> <span class=n>OrderManagement</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>	<span class=k>rpc</span> <span class=n>updateOrders</span><span class=p>(</span><span class=n>stream</span> <span class=n>Order</span><span class=p>)</span> <span class=k>returns</span> <span class=p>(</span><span class=n>google.protobuf.StringValue</span><span class=p>);</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div></li></ul></li><li><p>服务端实现：</p><ul><li><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-11-1><a class=lnlinks href=#hl-11-1>1</a>
</span><span class=lnt id=hl-11-2><a class=lnlinks href=#hl-11-2>2</a>
</span><span class=lnt id=hl-11-3><a class=lnlinks href=#hl-11-3>3</a>
</span><span class=lnt id=hl-11-4><a class=lnlinks href=#hl-11-4>4</a>
</span><span class=lnt id=hl-11-5><a class=lnlinks href=#hl-11-5>5</a>
</span><span class=lnt id=hl-11-6><a class=lnlinks href=#hl-11-6>6</a>
</span><span class=lnt id=hl-11-7><a class=lnlinks href=#hl-11-7>7</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>s</span> <span class=o>*</span><span class=nx>server</span><span class=p>)</span> <span class=nf>UpdateOrders</span><span class=p>(</span><span class=nx>stream</span> <span class=nx>pb</span><span class=p>.</span><span class=nx>OrderManagement_UpdateOrdersServer</span><span class=p>)</span> <span class=kt>error</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=nx>order</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>stream</span><span class=p>.</span><span class=nf>Recv</span><span class=p>()</span>
</span></span><span class=line><span class=cl>  <span class=o>...</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>stream</span><span class=p>.</span><span class=nf>SendAndClose</span><span class=p>(</span><span class=o>...</span><span class=p>)</span>  <span class=c1>// 服务端通过该方法发送响应
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=o>...</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div></li></ul></li><li><p>客户端实现：</p><ul><li><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-12-1><a class=lnlinks href=#hl-12-1>1</a>
</span><span class=lnt id=hl-12-2><a class=lnlinks href=#hl-12-2>2</a>
</span><span class=lnt id=hl-12-3><a class=lnlinks href=#hl-12-3>3</a>
</span><span class=lnt id=hl-12-4><a class=lnlinks href=#hl-12-4>4</a>
</span><span class=lnt id=hl-12-5><a class=lnlinks href=#hl-12-5>5</a>
</span><span class=lnt id=hl-12-6><a class=lnlinks href=#hl-12-6>6</a>
</span><span class=lnt id=hl-12-7><a class=lnlinks href=#hl-12-7>7</a>
</span><span class=lnt id=hl-12-8><a class=lnlinks href=#hl-12-8>8</a>
</span><span class=lnt id=hl-12-9><a class=lnlinks href=#hl-12-9>9</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=nx>c</span> <span class=o>:=</span> <span class=nx>pb</span><span class=p>.</span><span class=nf>NewOrderManagementClient</span><span class=p>(</span><span class=nx>conn</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>updateStream</span><span class=p>.</span><span class=nf>Send</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>upOrder1</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>  <span class=c1>// 客户端通过 Send 连续发送多条请求
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=o>...</span>
</span></span><span class=line><span class=cl><span class=nx>updateRes</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>updateStream</span><span class=p>.</span><span class=nf>CloseAndRecv</span><span class=p>()</span>  <span class=c1>// 接收响应
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>...</span>
</span></span></code></pre></td></tr></table></div></div></li></ul></li></ul><h3 id=双向流-rpc-模式>双向流 RPC 模式<a hidden class=anchor aria-hidden=true href=#双向流-rpc-模式>#</a></h3><p>在双向流 RPC 模式中，客户端以消息流的形式发送请求到服务端，服务端也以消息流形式响应。</p><p>流的操作完全独立，客户端和服务端可以按照任意顺序进行读取和写入。一旦建立连接，通信模式就完全取决于客户端和服务端本身。</p><h2 id=grpc-的底层原理>gRPC 的底层原理<a hidden class=anchor aria-hidden=true href=#grpc-的底层原理>#</a></h2><h3 id=rpc-流>RPC 流<a hidden class=anchor aria-hidden=true href=#rpc-流>#</a></h3><p>一个基本的 gRPC 过程，以 getProduct 方法为例：</p><ol><li>客户端通过生成的存根调用 getProduct方法；</li><li>客户端存根使用已编码的消息创建 POST 请求。在 gRPC 中所有的请求都是 PSOT，并且 content-type 的值为 application/grpc ；</li><li>HTTP 请求消息通过网络发送到服务端；</li><li>接收到消息后，服务端检查消息头消息，确定要调用的方法，然后将消息传递给服务端骨架；</li><li>服务端骨架将消息解析成特定的数据结构；</li><li>借助解析后的消息，服务发起对 getProduct 方法的本地调用。</li></ol><p>gRPC 的这些步骤与其他 RPC 方式很相似，而主要区别在与消息的编码方式。gRPC 采用 protocol buffers。</p><h3 id=使用-protocol-buffers-编码消息>使用 protocol buffers 编码消息<a hidden class=anchor aria-hidden=true href=#使用-protocol-buffers-编码消息>#</a></h3><p>对于 protocol buffers 中的消息定义：</p><ul><li><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt id=hl-13-1><a class=lnlinks href=#hl-13-1>1</a>
</span><span class=lnt id=hl-13-2><a class=lnlinks href=#hl-13-2>2</a>
</span><span class=lnt id=hl-13-3><a class=lnlinks href=#hl-13-3>3</a>
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-protobuf data-lang=protobuf><span class=line><span class=cl><span class=kd>message</span> <span class=nc>ProductID</span> <span class=p>{</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span>	<span class=kt>string</span> <span class=n>value</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=p>}</span><span class=err>
</span></span></span></code></pre></td></tr></table></div></div></li><li><p>消息在经过编码后的字节流：消息字段1、消息字段2、….、结束标志。</p><ul><li>每个消息字段由标签、值两部分组成，标签由字段索引和线路类型（wire type）组成，字段索引就是上面消息定义里的“1”，线路类型则是该消息字段所属数据结构的类型，如 string 属于 “2:基于长度分隔”，那么其线路类型就是 2。值的编码会根据数据类型而不同。</li></ul></li></ul><h3 id=基于长度前缀的消息分帧>基于长度前缀的消息分帧<a hidden class=anchor aria-hidden=true href=#基于长度前缀的消息分帧>#</a></h3><p>长度前缀分帧是指在写入消息本身之前，写入长度信息，来表明每条消息的大小。</p><p>在 gRPC 通信中，每条消息都有额外的4字节用来设置其大小，这表示 gRPC 通信可以处理大小不超过 4GB 的所有消息。</p><p>除了消息的大小外，还有单字节的无符号整数，用于表明数据是否进行了压缩。</p><h3 id=基于-http2-的-grpc>基于 HTTP/2 的 gRPC<a hidden class=anchor aria-hidden=true href=#基于-http2-的-grpc>#</a></h3><ul><li>请求消息：请求消息包含请求头信息、以长度作为前缀的消息、流结束标记 EOS。远程调用会在客户端发送请求信息之后就会初始化，然后发送以长度作为前缀的消息，最后发送 EOS 标记。</li><li>响应消息：响应消息包含响应头消息、以长度作为前缀的消息、trailer，这个也是发送顺序。</li></ul><p>那么，从这个角度再来重新看下 gRPC 的通信模式：</p><ul><li>一元 RPC 模式：就是以上面消息原始的方式互相发出去；</li><li>服务端流 RPC 模式：请求消息不变，响应消息中以长度作为前缀的消息可以是多个；</li><li>客户端流 RPC 模式：响应消息不变，请求消息中以长度作为前缀的消息可以是多个；</li><li>双向流 RPC 模式：两种消息的以长度作为前缀的消息都可以是多个。</li></ul><p>至此，gRPC 在 HTTP/2 层的原理介绍就到这了。</p><h2 id=grpc超越基础知识>gRPC：超越基础知识<a hidden class=anchor aria-hidden=true href=#grpc超越基础知识>#</a></h2><p>这一部分就不看了，就简单的把 gRPC 还能干啥写出来：</p><ul><li>拦截器</li><li>截止时间</li><li>取消</li><li>错误处理</li><li>多路复用</li><li>元数据</li><li>负载均衡</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=http://localhost:1313/tags/rpc/>RPC</a></li><li><a href=http://localhost:1313/tags/cloud-native/>Cloud Native</a></li><li><a href=http://localhost:1313/tags/golang/>Golang</a></li></ul><nav class=paginav><a class=prev href=http://localhost:1313/posts/dailydev/%E9%AB%98%E6%95%88%E4%BD%BF%E7%94%A8redis%E8%AE%B0%E5%BD%95/><span class=title>« Prev</span><br><span>《高效使用Redis》记录</span>
</a><a class=next href=http://localhost:1313/posts/dailydev/%E6%B7%B1%E5%85%A5rabbitmq%E8%AE%B0%E5%BD%95/><span class=title>Next »</span><br><span>《深入RabbitMQ》记录</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=http://localhost:1313/>KurongBlog</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>